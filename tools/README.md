# dEQP Auto Test Tools

è‡ªåŠ¨åŒ– dEQP (drawElements Quality Program) æµ‹è¯•å·¥å…·ï¼Œç”¨äºé€šè¿‡ä¸²å£æ§åˆ¶åµŒå…¥å¼è®¾å¤‡æ‰§è¡Œ OpenGL ES ä¸€è‡´æ€§æµ‹è¯•ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
tools/
â”œâ”€â”€ run_auto_test.py      # ä¸»å…¥å£è„šæœ¬
â””â”€â”€ lib/
    â”œâ”€â”€ __init__.py       # æ¨¡å—å¯¼å‡º
    â”œâ”€â”€ test_parser.py    # XML æµ‹è¯•ç”¨ä¾‹è§£æå™¨
    â”œâ”€â”€ serial_utils.py   # ä¸²å£é€šä¿¡å·¥å…·
    â”œâ”€â”€ device_control.py # è®¾å¤‡æ§åˆ¶ï¼ˆé‡ç½®ã€å­˜æ´»æ£€æµ‹ï¼‰
    â”œâ”€â”€ test_runner.py    # æµ‹è¯•æ‰§è¡Œé€»è¾‘
    â””â”€â”€ utils.py          # é€šç”¨å·¥å…·å‡½æ•°
```

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **XML è§£æ**: è§£æ dEQP æµ‹è¯•ç”¨ä¾‹ XML æ–‡ä»¶ï¼Œæå–æµ‹è¯•ç»„å’Œæµ‹è¯•ç”¨ä¾‹
- **ä¸²å£é€šä¿¡**: é€šè¿‡ä¸²å£å‘åµŒå…¥å¼è®¾å¤‡å‘é€æµ‹è¯•å‘½ä»¤
- **è‡ªåŠ¨é‡ç½®**: æ¯ä¸ªæµ‹è¯•ç»„æ‰§è¡Œåè‡ªåŠ¨é‡ç½®è®¾å¤‡
- **çŠ¶æ€æ£€æµ‹**: æ£€æµ‹æµ‹è¯•å®Œæˆã€ç³»ç»Ÿå´©æºƒï¼ˆPANICï¼‰ã€ç³»ç»ŸæŒ‚èµ·ç­‰çŠ¶æ€
- **æ–­ç‚¹ç»­æµ‹**: æ”¯æŒä»æŒ‡å®šæµ‹è¯•ç»„å¼€å§‹ï¼Œè·³è¿‡å·²å®Œæˆçš„æµ‹è¯•
- **æ—¥å¿—è®°å½•**: ä¸ºæ¯ä¸ªæµ‹è¯•ç»„ç”Ÿæˆç‹¬ç«‹çš„æ—¥å¿—æ–‡ä»¶
- **CSV æŠ¥å‘Š**: ç”ŸæˆåŒ…å«æ‰€æœ‰æµ‹è¯•ç»“æœçš„ CSV æŠ¥å‘Š
- **è¿›åº¦æ˜¾ç¤º**: å®æ—¶æ˜¾ç¤ºæµ‹è¯•è¿›åº¦ã€ç»Ÿè®¡ä¿¡æ¯å’Œæ—¶é—´

## ğŸ“‹ ä¾èµ–è¦æ±‚å’Œå®‰è£…æ­¥éª¤

### å®‰è£…ä¾èµ–

ä½¿ç”¨ requirements.txt æ–‡ä»¶å®‰è£…æ‰€æœ‰å¿…éœ€ä¾èµ–ï¼š

```bash
# å®‰è£…æ ¸å¿ƒä¾èµ–
pip install -r requirements.txt

# æˆ–è€…æ‰‹åŠ¨å®‰è£…
pip install pyserial tabulate
```

### å¼€å‘å·¥å…·ï¼ˆå¯é€‰ï¼‰

å¦‚éœ€è¿›è¡Œä»£ç æ ¼å¼åŒ–å’Œæ£€æŸ¥ï¼Œå¯å®‰è£…å¼€å‘å·¥å…·ï¼š

```bash
# ä»£ç æ ¼å¼åŒ–å·¥å…·
pip install black

# ä»£ç æ£€æŸ¥å·¥å…·  
pip install pylint

# è¿è¡Œä»£ç æ£€æŸ¥
python code_check.py
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬å‘½ä»¤

```bash
cd tools

# æŸ¥çœ‹å¸®åŠ©
python3 run_auto_test.py -h

# æ˜¾ç¤ºæµ‹è¯•ç”¨ä¾‹ç»“æ„ï¼ˆé»˜è®¤æ·±åº¦ï¼‰
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml

# æ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml --summary

# åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml --list-tests

# åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç»„
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml --list-groups
```

### è¿è¡Œæµ‹è¯•

```bash
# åŸºæœ¬æµ‹è¯•è¿è¡Œ
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml \
    --run-tests \
    --test-port /dev/ttyUSB1

# å®Œæ•´æµ‹è¯•è¿è¡Œï¼ˆå¸¦è®¾å¤‡é‡ç½®ï¼‰
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml \
    --run-tests \
    --test-port /dev/ttyUSB1 \
    --reset-port /dev/ttyCH341USB1

# ä»æŒ‡å®šç»„å¼€å§‹æµ‹è¯•ï¼ˆæ–­ç‚¹ç»­æµ‹ï¼‰
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml \
    --run-tests \
    --test-port /dev/ttyUSB1 \
    --reset-port /dev/ttyCH341USB1 \
    --start-group "dEQP-GLES2.functional.shaders"

# æ‰“å°è®¾å¤‡è¾“å‡ºæ—¥å¿—
python3 run_auto_test.py -f ../dEQP-GLES2-cases.xml \
    --run-tests \
    --test-port /dev/ttyUSB1 \
    --print-output
```

## âš™ï¸ å‘½ä»¤è¡Œå‚æ•°

### è¾“å…¥æ–‡ä»¶

| å‚æ•° | è¯´æ˜ |
|------|------|
| `-f, --file` | XML æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶è·¯å¾„ï¼ˆå¿…éœ€ï¼‰ |

### æ˜¾ç¤ºé€‰é¡¹

| å‚æ•° | è¯´æ˜ |
|------|------|
| `-d, --depth` | æ˜¾ç¤ºçš„æœ€å¤§æ·±åº¦ï¼ˆé»˜è®¤ï¼šå…¨éƒ¨ï¼‰ |
| `--list-tests` | åˆ—å‡ºæ‰€æœ‰å¯æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹è·¯å¾„ |
| `--list-groups` | åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç»„è·¯å¾„ |
| `--summary` | ä»…æ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯ |

### æµ‹è¯•æ‰§è¡Œ

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--run-tests` | æŒ‰ç»„è¿è¡Œæµ‹è¯• |
| `--test-port` | æµ‹è¯•å‘½ä»¤ä¸²å£ï¼ˆå¦‚ /dev/ttyUSB0ï¼‰ |
| `--test-baudrate` | æµ‹è¯•ä¸²å£æ³¢ç‰¹ç‡ï¼ˆé»˜è®¤ï¼š921600ï¼‰ |
| `--test-timeout` | æµ‹è¯•å“åº”è¶…æ—¶ç§’æ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰ |

### è®¾å¤‡é‡ç½®

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--reset-port` | é‡ç½®æ§åˆ¶ä¸²å£ï¼ˆå¦‚ /dev/ttyUSB1ï¼‰ |
| `--reset-baudrate` | é‡ç½®ä¸²å£æ³¢ç‰¹ç‡ï¼ˆé»˜è®¤ï¼š9600ï¼‰ |
| `--reset-wait` | é‡ç½®åç­‰å¾…æ—¶é—´ç§’æ•°ï¼ˆé»˜è®¤ï¼š5ï¼‰ |

### æµ‹è¯•æ§åˆ¶

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--max-wait-count` | æœ€å¤§ç­‰å¾…å°è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰ |
| `--log-dir` | æ—¥å¿—ç›®å½•ï¼ˆé»˜è®¤ï¼šè‡ªåŠ¨åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„ç›®å½•ï¼‰ |
| `--start-group` | ä»æŒ‡å®šç»„å¼€å§‹æµ‹è¯•ï¼ˆè·³è¿‡ä¹‹å‰çš„ç»„ï¼‰ |
| `--print-output` | æ‰“å°è®¾å¤‡ä¸²å£è¾“å‡ºï¼ˆé»˜è®¤ï¼šç¦ç”¨ï¼‰ |

## ğŸ“Š æµ‹è¯•ç»“æœ

### ç»“æœçŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| `PASSED` | æµ‹è¯•æˆåŠŸå®Œæˆï¼ˆæ£€æµ‹åˆ° "DONE!"ï¼‰ |
| `CRASH` | ç³»ç»Ÿå´©æºƒï¼ˆæ£€æµ‹åˆ° "PANIC"ï¼‰ |
| `HANG` | ç³»ç»Ÿæ— å“åº”ï¼ˆfree å‘½ä»¤æ— å“åº”ï¼‰ |
| `TIMEOUT` | è¶…æ—¶ï¼ˆè¶…è¿‡æœ€å¤§ç­‰å¾…æ¬¡æ•°ï¼‰ |

### è¾“å‡ºæ–‡ä»¶

æµ‹è¯•å®Œæˆåï¼Œåœ¨æ—¥å¿—ç›®å½•ä¸­ç”Ÿæˆï¼š

```
logs_YYYYMMDD_HHMMSS/
â”œâ”€â”€ test_report.csv                              # CSV æµ‹è¯•æŠ¥å‘Š
â”œâ”€â”€ dEQP-GLES2_functional_shaders_xxx.log       # å„æµ‹è¯•ç»„æ—¥å¿—
â””â”€â”€ ...
```

### CSV æŠ¥å‘Šæ ¼å¼

```csv
Index,Group Path,Result,Duration (s),Start Time,End Time
1,dEQP-GLES2.functional.shaders.xxx,PASSED,15.32,2025-12-12 10:00:00,2025-12-12 10:00:15
...

# Summary
Total Groups,941
Skipped,0
To Test,941
Completed,100
Passed,95
Failed,0
Timeout,3
Hang,1
Crash,1
Pass Rate (%),95.0
Total Time (s),3600.00
Avg Time per Group (s),36.00
```

## ğŸ”§ è®¾å¤‡é‡ç½®åè®®

é»˜è®¤ä½¿ç”¨ä»¥ä¸‹ HEX å‘½ä»¤è¿›è¡Œè®¾å¤‡é‡ç½®ï¼š

- **ä¸Šç”µå‘½ä»¤**: `A0 01 01 A2`
- **æ–­ç”µå‘½ä»¤**: `A0 01 00 A1`

å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç¼–è¾‘ `lib/device_control.py` ä¸­çš„ `reset_device()` å‡½æ•°ã€‚

## ğŸ“ ç¤ºä¾‹è¾“å‡º

```
2025-12-12 10:00:00 - INFO - ============================================
2025-12-12 10:00:00 - INFO - Total leaf groups to test: 941 (skipped: 0)
2025-12-12 10:00:00 - INFO - ============================================
2025-12-12 10:00:00 - INFO - Log directory: logs_20251212_100000
2025-12-12 10:00:00 - INFO - Writing test report to: logs_20251212_100000/test_report.csv

2025-12-12 10:00:05 - INFO - ================================================
2025-12-12 10:00:05 - INFO - [1/941] (#1/941) Testing group: dEQP-GLES2.xxx
2025-12-12 10:00:05 - INFO - ================================================
2025-12-12 10:00:05 - INFO - Writing log to: logs_20251212_100000/dEQP-GLES2_xxx.log
2025-12-12 10:00:20 - INFO - Group dEQP-GLES2.xxx completed successfully.
2025-12-12 10:00:20 - INFO - Case duration: 15.3s

2025-12-12 10:00:20 - INFO - Progress: [â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 1/941 (0.1%)
2025-12-12 10:00:20 - INFO - Results:  âœ… Passed: 1  âŒ Failed: 0  â± Timeout: 0  ğŸ’€ Hang: 0  ğŸ’¥ Crash: 0
2025-12-12 10:00:20 - INFO - Time:     â± Case: 15.3s  ğŸ“Š Total: 15.3s
```

## ğŸ—ï¸ æ¨¡å—è¯´æ˜

### test_parser.py

- `TestCase`: æµ‹è¯•ç”¨ä¾‹æ•°æ®ç±»
- `TestCaseParser`: XML è§£æå™¨ï¼Œæä¾›æµ‹è¯•è·¯å¾„æ”¶é›†æ–¹æ³•

### serial_utils.py

- `serial_open()`: æ‰“å¼€ä¸²å£
- `serial_write()`: å‘é€å­—ç¬¦ä¸²å‘½ä»¤
- `serial_write_hex()`: å‘é€ HEX æ•°æ®
- `serial_wait_for_response()`: ç­‰å¾…å…³é”®å­—å“åº”

### device_control.py

- `check_system_alive()`: å‘é€ `free` å‘½ä»¤æ£€æµ‹ç³»ç»Ÿå­˜æ´»
- `reset_device()`: å‘é€é‡ç½®å‘½ä»¤å¹¶ç­‰å¾…è®¾å¤‡å¯åŠ¨

### test_runner.py

- `build_test_command()`: æ„å»º openglcts æµ‹è¯•å‘½ä»¤
- `run_group_tests()`: ä¸»æµ‹è¯•æ‰§è¡Œå¾ªç¯

### utils.py

- `format_duration()`: æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
- `print_title_info()`: æ‰“å°å¸¦è¾¹æ¡†çš„æ ‡é¢˜
- `print_progress()`: æ‰“å°è¿›åº¦æ¡å’Œç»Ÿè®¡ä¿¡æ¯
